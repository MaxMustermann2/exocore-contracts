name: Comment the triggering CI status on the PR

on:
  workflow_run:
    workflows: ["Forge CI", "Slither Analysis", "Run `solhint` linter"]
    types:
      - completed

permissions:
  pull-requests: write
  issues: read
  # for cache restore
  contents: read

jobs:
  comment_status:
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.restore.outputs.pr-number }}
    steps:
      # Log the workflow trigger details for debugging.
      - name: Echo workflow trigger details
        run: |
          echo "Workflow run event: ${{ github.event.workflow_run.event }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Workflow run name: ${{ github.event.workflow_run.name }}"
          echo "Workflow run URL: ${{ github.event.workflow_run.html_url }}"
          echo "Commit SHA: ${{ github.event.workflow_run.head_commit.id }}"
          echo "Workflow Run ID: ${{ github.event.workflow_run.id }}"
      # Checkout the repository to make the composite action available.
      - name: Checkout repository
        uses: actions/checkout@v3
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
      - name: Restore the cached PR number, if available
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        uses: actions/cache/restore@v3
        with:
          key: pr-number-cache-${{ github.event.workflow_run.head_commit.id }}
          path: res.txt
      - name: Save the PR number to the outputs
        id: restore
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        run: |
          pr_number=$(cat res.txt)
          echo "PR number: $pr_number"
          echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
      # Finally, run the composite action to post/update the status comment.
      - name: Update CI Status
        uses: ./.github/actions/composite-action-pr-status-comment
        if: ${{ github.event.workflow_run.event == 'pull_request' }}
        with:
          workflow-conclusion: ${{ github.event.workflow_run.conclusion }}
          workflow-url: ${{ github.event.workflow_run.html_url }}
          workflow-name: ${{ github.event.workflow_run.name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ steps.restore.outputs.pr-number }}
